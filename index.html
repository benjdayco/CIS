<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <title>Confinancing Information System</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!--Datatables css-->
    <link rel="stylesheet" type="text/css" href="css/dataTables.bootstrap.min.css">
    <!-- Custom styles for this template go here -->


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!--CIS stylesheet-->
    <link rel="stylesheet" href="css/styles.css">
  </head>

  <body>

    <!--HEADER BAR-->
    <div class="container-fluid">
      <div class="row header-bar">
          <img src="img/masthead_adblogo.gif" alt="ADB logo">
          <h2 class="tblue"> Confinancing Information System</h2>
      </div>
    </div>
    <!--END OF HEADER BAR-->

   <!--NAV BAR-->
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <li class="active"><a href="">Home Dashboard <span class="sr-only">(current)</span></a></li>
            <li><a href="trust-funds-home.html">Trust Funds</a></li>

            <li><a href="cofinance-projects-home.html">Project Specific Cofinancing </a></li>  
            <li><a href="partners.html">Partners</a></li>  
            <li><a href="#">About This Website</a></li>  
            <li><a href="#">Contact Us</a></li>  
          </ul> 
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
  <!--END OF NAV BAR-->

  <!--MAIN BODY-->
 <!-- here goes the map -->
    <div id="map-canvas"> </div>

    <!-- the draggable input and display controls -->
    <div id="draggable">
      <label>Number of Projects</label>
      <div id="radius-label">radius: 20</div>
      <div id="radius-slider"></div>

      <div id="opacity-label">opacity: 0.5</div>
      <div id="opacity-slider"></div>

      <div id="max-label">max: -</div>
      <div id="max-slider"></div>
    </div>

    <hr>
  <!--END OF MAIN BODY-->
  
  <!--FOOTER-->
  <footer>
    <div class="container">
      <div class="left-footer">
        <img src="img/colophon.gif">
      </div>
      <div class="fright tbottom">
       Comments to <a href="mailto:adb@adb.org">adb@adb.org</a> 
      </div>
    </div>  
      <div class="container">
      <div class="left-footer">
        <i>Copyright &copy; 2016 Asian Development Bank</i>
      </div>
      <div class="fright">
      <i>Last reviewed  10 Dec 2016</i></a> 
      </div>
    </div>  
  </footer> 
  <!--END of FOOTER-->

  </body>
    <!-- All your JavaScript comes now -->
    <!-- ============================= -->
  <!--you need this to parse csv-->
  <script src="js/papaparse.min.js"></script>
  <!--link to google map api-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDQiCo59iNzTIFXLlmre8HpZ48JhD5eYfU&v=3.exp&libraries=visualization"></script>

  <script src="js/jquery.min.js"></script>
  <script src="https://code.jquery.com/ui/1.11.0/jquery-ui.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">

  <script>
    var map, pointarray, heatmap;
    var csv = [];
    // http://stackoverflow.com/a/2901298/562440
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    function loadData() {
    
     var data = "\"weight\",\"lat\",\"lon\",\"cnt\"\n167,34.543896,69.160652,AFG\n44,40.1772,44.50349,ARM\n63,40.409264,49.867092,AZE\n768,23.728783,90.393791,BAN\n197,27.4728,89.6393,BHU\n2,4.5353,114.7277,BRU\n400,12.5657,104.991,CAM\n57,21.2367,159.7777,COO\n117,17.7134,178.065,FIJ\n67,7.4256,150.5508,FSM\n47,41.716667,44.783333,GEO\n5,22.3964,114.1095,HKG\n644,20.5937,78.9629,IND\n952,0.7893,113.9213,INO\n117,43.238949,76.889709,KAZ\n176,41.2044,74.7661,KGZ\n59,3.3704,168.734,KIR\n112,35.9078,127.7669,KOR\n459,19.8563,102.4955,LAO\n170,4.2105,101.9758,MAL\n99,3.2028,73.2207,MLD\n328,46.8625,103.8467,MON\n153,21.9162,95.956,MYA\n22,0.5228,166.9315,NAU\n605,28.3949,84.124,NEP\n756,30.3753,69.3451,PAK\n13,7.515,134.5825,PAL\n685,12.8797,121.774,PHI\n268,9.4780,147.1507,PNG\n1169,35.8617,104.1954,PRC\n77,7.1315,171.1845,RMI\n162,13.759,172.1046,SAM\n17,1.3521,103.8198,SIN\n132,9.6457,160.1562,SOL\n516,7.8731,80.7718,SRI\n154,38.861,71.2761,TAJ\n14,23.6978,120.9605,TAP\n279,15.87,100.9925,THA\n74,8.8742,125.7275,TIM\n9,38.9697,59.5563,TKM\n100,21.179,175.1982,TON\n36,7.1095,177.6493,TUV\n187,41.3775,64.5853,UZB\n94,15.3767,166.9592,VAN\n585,14.0583,108.2772,VIE"
      Papa.parse(data, {
        header: true,
        dynamicTyping: true,
        complete: function(results) {
          csv = [];
          markerArray = [];
          var infoWindow = new google.maps.InfoWindow(),marker, i;
        
          if(results.meta.fields.indexOf("weight") == -1) {
            for(idx in results["data"]) {
              var row = results["data"][idx];
              csv.push(new google.maps.LatLng(row["lat"], row["lon"]))
            }
          } else {
            var max = results["data"][0]["weight"];
            for(idx in results["data"]) {
              var row = results["data"][idx];
             
              max = Math.max(max, row["weight"]);

              var newLocation = new google.maps.LatLng(row["lat"], row["lon"]);
              
              //Generate info windows
              content = row["cnt"] +'-'+row["weight"]+' projects'; 

              var image = {
                  url: 'https://upload.wikimedia.org/wikipedia/commons/1/1c/Square.gif',
                  // This marker is 20 pixels wide by 32 pixels high.
                    size: new google.maps.Size(32, 32),
                    // The origin for this image is (0, 0).
                    origin: new google.maps.Point(0, 0),
                    // The anchor for this image is the base of the flagpole at (0, 32).
                    anchor: new google.maps.Point(16, 16)
              };
              // Shapes define the clickable region of the icon. The type defines an HTML
              // <area> element 'poly' which traces out a polygon as a series of X,Y points.
              // The final coordinate closes the poly by connecting to the first coordinate.
              var shape = {
                coords: [32, 1, 1, 20, 18, 20, 18, 32],
                type: 'poly'
              };
              var marker = new google.maps.Marker({
              position: newLocation,
              map: map,
              icon: image,
              opacity:0.0,
              shape: shape,
              title: content
            });

              //push into csv
              csv.push({
                location: newLocation,
                weight: row["weight"],

              });

            
            }

            $("#max-label").html("max: "+numberWithCommas(max));
            $("#max-slider").slider("option","max",max);
            $("#max-slider").slider("option","value",max);
          }
          
          console.log(results);
                    
          loadHeatmap(csv);
        }
      });
    }
    
    function initialize() {
      var mapOptions = {
      zoom: 3,
      center: new google.maps.LatLng(14, 120),
      mapTypeId: google.maps.MapTypeId.MAP
      };
      map = new google.maps.Map(document.getElementById('map-canvas'),
        mapOptions);

      loadData();
    }
    
    function loadHeatmap(csv) {
      var pointArray = new google.maps.MVCArray(csv);
      if(heatmap) heatmap.setMap(null);
      
      heatmap = new google.maps.visualization.HeatmapLayer({
        data: pointArray,
        radius: $("#radius-slider").slider("value"),
        opacity: $("#opacity-slider").slider("value")
      });
      
      heatmap.setMap(map);
    }
    
    $(document).ready(function(){
      
      google.maps.event.addDomListener(window, 'load', initialize);
      
      $(function() {
        $( "#draggable" ).draggable();
      });
      
      $(function() {
        $( "#radius-slider" ).slider({
          orientation: "horizontal",
          range: "min",
          min: 1,
          max: 50,
          value: 20,
          slide: function(event, ui) {
            $("#radius-label").html("radius: " + ui.value);
            if(heatmap == null) return;
            heatmap.set('radius', ui.value);
          }
        });
        $( "#opacity-slider" ).slider({
          orientation: "horizontal",
          range: "min",
          min: 0,
          max: 100,
          value: 50,
          slide: function(event, ui) {
            $("#opacity-label").html("opacity: " + ui.value/100);
            if(heatmap == null) return;
            heatmap.set('opacity', ui.value/100);
          }
        });
        $( "#max-slider" ).slider({
          orientation: "horizontal",
          range: "min",
          min: 0,
          max: 1,
          value: 0,
          slide: function(event, ui) {
            $("#max-label").html("max: " + numberWithCommas(ui.value));
            if(heatmap == null) return;
            heatmap.set('maxIntensity', ui.value);
          }
        });
      });
       
    });
 
  </script>
</html>
